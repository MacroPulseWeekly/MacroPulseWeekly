name: Update MacroPulseWeekly Charts

permissions:
  contents: write

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install yfinance pytrends plotly pandas

      - name: Run chart generator
        run: |
          python3 generate_charts.py

      - name: Inject BTC Quantile Model into index.html
        run: |
          python - << 'EOF'
          from pathlib import Path

          index_path = Path("index.html")
          quantile_path = Path("charts/btc_quantile_model.html")

          index_html = index_path.read_text(encoding="utf-8")
          quantile_html = quantile_path.read_text(encoding="utf-8")

          start_marker = "<!-- BTC_QUANTILE_START -->"
          end_marker = "<!-- BTC_QUANTILE_END -->"

          if start_marker not in index_html or end_marker not in index_html:
              raise SystemExit("Quantile markers not found in index.html")

          before, rest = index_html.split(start_marker, 1)
          middle, after = rest.split(end_marker, 1)

          new_index = (
              before
              + start_marker
              + "\n"
              + quantile_html
              + "\n"
              + end_marker
              + after
          )

          index_path.write_text(new_index, encoding="utf-8")
          EOF

      - name: Commit updated charts
        run: |
          git config --local user.email "github-actions@github.com"
          git config --local user.name "github-actions"
          git add charts/*.html index.html
          git commit -m "Automated chart update" || echo "No changes to commit"
          git push
